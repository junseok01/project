<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayout}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="imagetoolbar" content="no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="title" content="웹사이트">
    <meta name="description" content="웹사이트입니다.">
    <meta name="keywords" content="키워드,키워드,키워드">
    <meta property="og:title" content="웹사이트">
    <meta property="og:description" content="웹사이트입니다">
    <meta property="og:image" content="https://웹사이트/images/opengraph.png">
    <meta property="og:url" content="https://웹사이트">
    <title>시설소개 | 프로젝트1610</title>
    <link rel="stylesheet" href="/css/gym/setting.css">
    <link rel="stylesheet" href="/css/gym/plugin.css">
    <link rel="stylesheet" href="/css/gym/template.css">
    <link rel="stylesheet" href="/css/gym/common.css">
    <link rel="stylesheet" href="/css/gym/style.css">
    <script src="https://kit.fontawesome.com/e4fcb5113c.js" crossorigin="anonymous"></script>
    <!-- jquery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- fullcalendar CDN -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
    <!-- fullcalendar 언어 CDN -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
    <!-- moment CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.0/moment.min.js" integrity="sha512-Izh34nqeeR7/nwthfeE0SI3c8uhFSnqxV0sI9TvTcXiFJkMd6fB644O64BRq2P/LA/+7eRvCw4GmLsXksyTHBg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        .calendarBox {
            overflow: hidden;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
            width: 80%;
            margin: 0 auto;
        }
        .main-content {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <main class="th-layout-main ">
        <!-- [S]campland-N8 -->
        <div class="campland-N8" data-bid="YdLxFmd3O9">
            <div class="contents-container">
                <img class="contents-visual img-pc" src="/images/health4.jpg" alt="서브 비주얼 PC 이미지">
                <img class="contents-visual img-mobile" src="/images/health4.jpg" alt="서브 비주얼 모바일 이미지">
                <div class="contents-body container-md">
                    <div class="textset textset-visual">
                        <h2 class="textset-tit" style="font-family: 'Pretendard-Regular'; color: whitesmoke">트레이너</h2>
                    </div>
                </div>
            </div>
        </div>
        <!-- [E]campland-N8 -->
        <!-- [S]campland-N10 -->
        <div class="campland-N10" data-bid="giLXFmD3rk">
            <div class="contents-inner">
                <div class="contents-container container-md">
                    <div class="textset textset-sub"  style="display: flex; flex-wrap: wrap;">
                        <div class="textbox">
                            <h2 class="textset-tit" style="font-family: 'Pretendard-Regular';">트레이너 정보</h2>
                        </div>
                        <div class="button2" style=" margin-left: 810px;">
                            <a th:href="@{/trainerdelete(boardNo=${trainer.boardNo})}" class="btnset btnset-round" style="  background-color: #1abc9c; float: right;">삭제하기</a>
                            <a href="javascript:void(0);" class="btnset btnset-round" style="  background-color: #1abc9c; ">수정하기</a>
                        </div>
                    </div>
                    <hr/>
                    <div class="textset textset-sub" style="display: flex; flex-wrap: wrap;">
                        <i class="fa-solid fa-user" style="margin-top: 30px; margin-right: 10px;"></i>
                        <h2 id="trainerName" class="textset-tit" style="font-family: 'Pretendard-Regular';" th:text="${trainer.name}"></h2>
                        <input type="hidden" id="userName" th:value="${session.member.loginId}">
                    </div>
                    <div class="textset textset-sub"  style="display: flex; flex-wrap: wrap;" >
                        <i class="fa-solid fa-dumbbell" style="margin-top: 30px; margin-right: 10px;"></i>
                        <h2 class="textset-tit" style="font-family: 'Pretendard-Regular';" th:text="${trainer.gymName}"></h2>
                    </div>
                    <div class="location" style=" display:flex; flex-wrap:wrap;">
                        <i class="fa-solid fa-location-dot" style="margin-top: 30px; margin-right: 10px;"></i>
                        <h2 class="textset-tit" style="font-family: 'Pretendard-Regular';" th:text="${trainer.addr}"></h2>
                    </div>
                    <div class="contents-body">
                        <div class="contents-left">
                            <div class="imageset">
                                <img class="imageset-img" src="/images/trainer3.jpg" alt="캠핑장 이미지">
                            </div>
                            <div class="imageset">
                                <img class="imageset-img" src="/images/trainer4.jpg" alt="캠핑장 이미지">
                            </div>
                        </div>
                        <div class="contents-right">
                            <div class="contents-group">
                                <h5 class="contents-subtit" style="font-family: 'SUITE-Regular';">이용금액</h5>
                                <ul class="contents-list">
                                    <li class="contents-item">
                                        <span class="contents-item-name">일일권</span>
                                        <span class="contents-item-price" th:text="${trainer.ticketprice}"></span>
                                    </li>
                                </ul>
                            </div>
                            <div class="contents-group">
                                <h5 class="contents-subtit"  style="font-family: 'SUITE-Regular';">트레이너 경력</h5>
                                <ul class="contents-list">
                                    <li class="contents-item">
                                        <span class="contents-item-name" th:text="${trainer.career}">------------ </span>
                                    </li>

                                </ul>
                            </div>
                            <div class="contents-group">
                                <h5 class="contents-subtit"  style="font-family: 'SUITE-Regular';">기타</h5>
                                <ul class="contents-list">
                                    <li class="contents-item">
                                        <span class="contents-item-name" th:text="${trainer.info}"></span>

                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="contents-button">
                        <a href="javascript:void(0);" class="btnset btnset-round" style="  background-color: #1abc9c;">등록하기</a>
                        <a href="javascript:void(0);" class="btnset btnset-round" style="  background-color: #1abc9c;">대화하기 </a>
                    </div>
                </div>
            </div>
        </div>
        <hr/>
        <h1 style="text-align: center">PT 신청하기</h1>
        <div class="main-content">
            <div class="calendarBox">
                <div id='calendar-container'>
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
            <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // calendar element 취득
                        let calendarEl = $('#calendar')[0];
                        // 오늘 날짜
                        let today = new Date();
                        // full-calendar 생성하기
                        let calendar = new FullCalendar.Calendar(calendarEl, {
                            height: '800px',// calendar 높이 설정
                            expandRows: true, // 화면에 맞게 높이 재설정
                            slotMinTime: '09:00', // Day 캘린더에서 시작 시간
                            slotMaxTime: '22:00', // Day 캘린더에서 종료 시간
                            // 해더에 표시할 툴바
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,listWeek'
                            },
                            initialView: 'timeGridWeek', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
                            initialDate: today, // 오늘날짜를 초기날짜로
                            navLinks: true, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
                            editable: true, // 수정 가능?
                            selectable: true, // 달력 일자 드래그 설정가능
                            nowIndicator: false, // 현재 시간 마크
                            dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)
                            locale: 'ko', // 한국어 설정

                            events: function (fetchInfo, successCallback) {
                                $.ajax({
                                    url: '/ptDayPasses/getReservations',
                                    method: 'GET',
                                    success: function (data) {
                                        let reservations = data.map(function (reservation) {
                                            let title, backgroundColor;
                                            if (reservation.status === 'accept'){
                                                title = '예약된 시간입니다.'
                                                backgroundColor = 'red'
                                            }else if (reservation.status === 'reject'){
                                                title = 'PT신청이 안되는 시간입니다.'
                                                backgroundColor = 'red'
                                            }else {
                                                title = '예약 진행중 입니다.'
                                                backgroundColor = 'orange'
                                            }
                                            return {
                                                title: title,
                                                start: reservation.startTime,
                                                end: reservation.endTime,
                                                backgroundColor: backgroundColor,
                                                editable: false
                                            };
                                        });
                                        let ptEvents = generatePtEvents(fetchInfo.start, fetchInfo.end, reservations);
                                        successCallback(reservations.concat(ptEvents));
                                    }
                                });
                            }
                        });
                        calendar.on('eventClick', function (info) {
                            if (info.event.backgroundColor === 'red' || info.event.backgroundColor === 'orange') {
                                alert("이미 예약된 상태거나 예약중 입니다.")
                                return;
                            }
                            let startTime = info.event.start;
                            let endTime = info.event.end;
                            let trainerName = $("#trainerName").text();
                            let userName = document.getElementById("userName").value;

                            // moment.js를 사용
                            let start = moment(startTime).format('YYYY-MM-DDTHH:mm');
                            let end = moment(endTime).format('YYYY-MM-DDTHH:mm');

                            if (ReservationCheck(trainerName,start,end) && confirm(start + '~' + end + '시간에 PT를 예약하시겠습니까?')) {
                                let reservationData = {
                                    user: userName,
                                    trainer: trainerName,
                                    startTime: start,
                                    endTime: end
                                };
                                $.ajax({
                                    type: 'POST',
                                    url: '/ptDayPasses/reserve',
                                    contentType: 'application/json',
                                    data: JSON.stringify(reservationData),
                                    success: function () {
                                        console.log(JSON.stringify(reservationData));
                                        alert('예약이 완료되었습니다');
                                        window.location.reload();
                                    },
                                    error: function () {
                                        console.log(JSON.stringify(reservationData));
                                        alert('예약에 실패했습니다. 다시 시도해주세요');
                                    }
                                });
                            }
                        });
                        // 캘린더 랜더링
                        calendar.render();
                    });
                    function generatePtEvents(start,end,reservations) {
                        let events = [];
                        let startDate = new Date();
                        let endDate = new Date(end);
                        let currentDate = new Date(startDate);

                            let times = [
                                'T09:00:00',
                                'T10:30:00',
                                'T13:00:00',
                                'T14:30:00',
                                'T16:00:00',
                                'T17:30:00',
                                'T19:00:00',
                                'T20:30:00'
                            ];
                            // 현재 시간 이후의 시간부터 예약가능
                            let startTimes = times.filter(time => {
                                let currentTime = moment(currentDate).format('YYYY-MM-DD')+time;
                                // isSameOrBefore = moment.js 에서 제공하는 메소드 (현재시간과 같거나 이전인지 비교)
                                return moment(currentDate).isSameOrBefore(moment(currentTime));
                            });
                            while (currentDate <= endDate) {
                                let eventDate = currentDate.toISOString().slice(0, 10); // YYYY-MM-DD 형식으로 날짜 문자열 생성
                                startTimes.forEach(function (time) {
                                    let startTime = eventDate + time;
                                    let endTime = new Date(new Date(startTime).getTime() + 60 * 60 * 1000).toISOString();

                                    let isReserved = reservations.some(function (reservation) {
                                        return (reservation.start <= startTime && reservation.end > startTime) ||
                                            (reservation.start < endTime && reservation.start >= endTime);
                                    });
                                    if (!isReserved) {
                                        events.push({
                                            title: 'PT신청하기',
                                            start: startTime,
                                            end: endTime
                                        });
                                    }
                                });
                                currentDate.setDate(currentDate.getDate() + 1);
                                startTimes = times; // 다음날짜는 모든 시간대가 조회되도록
                            }
                        return events;
                    }
                    function ReservationCheck(trainerName,start,end){
                        let statusCheck = true;
                        $.ajax({
                            type: 'GET',
                            url: '/ptDayPasses/checkStatus',
                            data: {
                                trainerName: trainerName,
                                startTime: start,
                                endTime: end
                            },
                            async: false, // 동기식 방식으로 처리 (응답을 모두 완료한 후 다음 로직 실행)
                            success: function (response) {
                                if (response.status === 'accept' || response === '신청 확인중') {
                                    statusCheck = false; // 예약 수락을 한 상태거나 누군가 예약을 한 상황이면 예약 불가능
                                }
                            },
                        });
                        return statusCheck;
                    }
            </script>

    </main>

</div>
<!-- [E]campland-N2 -->
<script src="js/gym/setting.js"></script>
<script src="js/gym/plugin.js"></script>
<script src="js/gym/template.js"></script>
<script src="js/gym/common.js"></script>
<script src="js/gym/script.js"></script>

</body>
</html>